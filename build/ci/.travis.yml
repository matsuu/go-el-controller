language: go
matrix:
  include:
    - go: 1.x
      env: LATEST=true
    - go: "1.13.12"
notifications:
  slack:
    secure: 5WrxIca1ASqQdhc13ZI3ZBsqpyYslwFrOGdFOs9Y5bd61BHwAl/UDomr+afHEavULiWCZUGuHzy33lRzarGSwcs7+CxzLEKd4elHaeNf+0Scu/dWb3gLm7ZpJ4m5tXReigrt4A0ZTNQkUpIN3BPqzrmFXiXQ3uG599fWH+F5Pz2mQqdLqwffpelLP92uWLwbLYDhN8qXohAr+mLrfUs99+5kW1kjbcNRFzOf5sAvX4Fqg9MFF5ZiQvp0MFOKnlW76Xox2+IQSQ+hAnygs7wx2AlFXkMQxLL2TsfbfaKI36oR7lV0VuuxNoh4mzj5GyOYkz6g219RZmfa/ZTCTOVOeZBK/a9S49oHHpr8UsUkcyD2doxRKYjDnwV0yM3GZPF2QnT1kd+y1MLPHEaN8ttejPdkZvnq399Z9EYWgs6IjduL2nFkFuoYeEClTqAI7uC5Mf6xYHBLOLhM8syLWaAPTxQByNzzNGRPu/cPWfhroaYxzfmN2XIg+xJiliYzOjirSHzizlDvC8UfouIoFaBz/1SJj6dSqizV3j6L4umQ5YgZUqUmvL7u0horA0ziO9JIuTwJBuIg+5ZOkdQTIKHkRc+UfOUT1Vt188JT0+tJ1upiQSFp0dGsxW7zdDEt4OtiodBDgjECQtknSII7QflefoGe2F4cX8xtAAQ3hCZaZqg=
install:
  - go get github.com/mitchellh/gox
  - go get -u github.com/google/go-cmp/cmp

script:
  - go get -v  ./...
  - go test -v ./...
  - |
    # Only build binaries from the latest Go release
    if [ "${LATEST}" = "true" ]; then 
      gox -osarch="linux/arm linux/amd64 darwin/amd64 windows/amd64" -ldflags "-X main.version=`git rev-parse --short HEAD`" ./cmd/elexporter/
      gox -osarch="linux/arm linux/amd64 darwin/amd64 windows/amd64" -ldflags "-X main.version=`git rev-parse --short HEAD`" ./cmd/smartmeter-exporter/
    fi

before_deploy:
      - git config --local user.name "u-one"
      - git config --local user.email "backflip270bb@gmail.com"
      - export TRAVIS_TAG=${TRAVIS_TAG:-$(date +'%Y%m%d%H%M%S')-$(git log --format=%h -1)}
      - git tag $TRAVIS_TAG
deploy:
  provider: releases
  api_key:
    secure: xzaOWtcIbMcFJP8ZuuHzDZisr5gPRAhVUQjdsCOyT6pQIivVkLnmZrah5VfJYRtcB71vi50oTEUUefBIRqJsjpI0sQesitnAqqjp9607E2MwH7oAxbZZa0r1HcqrzASuWOxje2k/qWV4XiFGER2vweodXlT/v9cz8GdXZJAeHgG6kIJ88P0Wfb0gV+i4nd1jOw2djL8gNykds3yQLU+JhaEgJ2JAepFKnWqjiSS7pBDvNRbWa5Gg4T6Vb/O+j1dX58Ws4RIYw4eqrMOTDz42Yh9Iehery9+dfe0Xwjnv8aJjefJbLQmtk6DsX5dzaGp84J13KP70ntNgnqdf3dainOrhn/io3nWHZIzfkA5ySXVc5W5B/PRk9zPvW2cPyzVK2tGWk2UHwAuo8oPvGQXMLSa4Dii+31FMGbRY8KwwNY301vNiJ7GRzyQ5K99DTxfZxcJGv4tzk0CIHDVQcqDreHeocX1A+2E9qXv6UedK7rovh0/SpMo0/Mjz5Nqf4oDEVVj1OVGlbq9An+KJMBh7V0D/UFW0q0ThOjZlzwlq7m0xBZKWaRFGscjpgJNuVX8/cPux8Uhc1QHO78SUcuinAbiGtjY/3CJ5i3q/8B0W96rA3hAByad069sZwpIYcHyiE8cHTsC3rWdSTCUmWqmgNUk2iKmqOa9WmhpSNVWvbl4=
  file: 
  - go-el-controller_arm6
  - go-el-controller_darwin_amd64
  - go-el-controller_linux_amd64
  - go-el-controller_linux_arm
  - go-el-controller_windows_amd64.exe

  skip_cleanup: true
  draft: true
  on:
    tags: false
    repo: u-one/go-el-controller
